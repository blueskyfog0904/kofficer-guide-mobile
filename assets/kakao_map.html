<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kakao Map</title>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error-msg {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid red;
            border-radius: 8px;
            color: red;
            text-align: center;
            z-index: 1000;
        }
        .marker-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 8px 12px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .marker-card:hover {
            transform: scale(1.05);
        }
        .marker-card.selected {
            border: 2px solid #3B82F6;
            background-color: #EFF6FF;
            z-index: 1000 !important;
        }
        .rank-badge {
            background-color: #3B82F6;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }
        .restaurant-name {
            font-size: 14px;
            font-weight: bold;
            color: #1F2937;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        .restaurant-distance {
            font-size: 12px;
            color: #6B7280;
            margin-left: 4px;
            flex-shrink: 0;
        }
        .my-location-marker {
            width: 24px;
            height: 24px;
            background-color: #EF4444;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        .my-location-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
        }
        .my-location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-color: rgba(239, 68, 68, 0.3);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>ì§€ë„ ë¡œë”© ì¤‘...</div>
    </div>
    <div id="error-msg"></div>
    <div id="map"></div>
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=KAKAO_JS_KEY_PLACEHOLDER&autoload=false"></script>
    <script>
        console.log('ğŸ”µ Kakao Map HTML loaded');
        
        // ì „ì—­ ë³€ìˆ˜
        var map = null;
        var markers = [];
        var overlays = [];
        var selectedOverlay = null;
        var selectedMarker = null; // ì„ íƒëœ ë§ˆì»¤
        var kakaoSdkReady = false;
        var pendingInit = null; // ëŒ€ê¸° ì¤‘ì¸ ì´ˆê¸°í™” ìš”ì²­
        var myLocationMarker = null; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
        var myLocationOverlay = null; // ë‚´ ìœ„ì¹˜ ì˜¤ë²„ë ˆì´
        var lastClickTime = 0; // ë”ë¸”í´ë¦­ ê°ì§€ìš©
        var lastClickId = null; // ë§ˆì§€ë§‰ í´ë¦­í•œ ë§ˆì»¤ ID
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (XSS ë°©ì§€)
        function escapeHtml(unsafe) {
            if (unsafe == null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // SDK ë¡œë”© ëŒ€ê¸° í•¨ìˆ˜
        function waitForKakaoSdk(callback, maxAttempts, attempt) {
            attempt = attempt || 0;
            maxAttempts = maxAttempts || 50;
            
            if (typeof kakao !== 'undefined' && kakao.maps) {
                console.log('âœ… Kakao SDK ready after', attempt, 'attempts');
                kakaoSdkReady = true;
                callback();
            } else if (attempt < maxAttempts) {
                setTimeout(function() {
                    waitForKakaoSdk(callback, maxAttempts, attempt + 1);
                }, 100);
            } else {
                console.error('âŒ Kakao SDK loading timeout');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').textContent = 'ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë”© ì‹œê°„ ì´ˆê³¼';
            }
        }
        
        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
        function createMyLocationMarker(lat, lng) {
            if (!map) return;
            
            // ê¸°ì¡´ ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ì œê±°
            if (myLocationOverlay) {
                myLocationOverlay.setMap(null);
            }
            
            var position = new kakao.maps.LatLng(lat, lng);
            
            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¡œ ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±
            var content = document.createElement('div');
            content.style.position = 'relative';
            content.innerHTML = 
                '<div class="my-location-pulse"></div>' +
                '<div class="my-location-marker"></div>';
            
            myLocationOverlay = new kakao.maps.CustomOverlay({
                position: position,
                content: content,
                yAnchor: 0.5,
                xAnchor: 0.5,
                zIndex: 100
            });
            myLocationOverlay.setMap(map);
            
            console.log('âœ… My location marker created at:', lat, lng);
        }
        
        // ì‹¤ì œ ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
        function doInitializeMap(centerLat, centerLng, markersJson, resolve, reject, showMyLocation) {
            kakao.maps.load(function() {
                try {
                    var restaurantData = JSON.parse(markersJson);
                    console.log('âœ… Parsed', restaurantData.length, 'markers');
                    
                    var container = document.getElementById('map');
                    var options = {
                        center: new kakao.maps.LatLng(centerLat, centerLng),
                        level: 5
                    };
                    
                    map = new kakao.maps.Map(container, options);
                    console.log('âœ… Map created with center:', centerLat, centerLng);
                    
                    // ì§€ë„ ì¤‘ì‹¬ì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    var actualCenter = map.getCenter();
                    console.log('âœ… Actual map center:', actualCenter.getLat(), actualCenter.getLng());
                    
                    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                    clearMarkers();
                    
                    // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ (showMyLocationì´ trueì¸ ê²½ìš°)
                    if (showMyLocation) {
                        createMyLocationMarker(centerLat, centerLng);
                    }
                    
                    var bounds = new kakao.maps.LatLngBounds();
                    var hasValidMarkers = false;
                    
                    // ë‚´ ìœ„ì¹˜ë„ boundsì— í¬í•¨
                    if (showMyLocation) {
                        bounds.extend(new kakao.maps.LatLng(centerLat, centerLng));
                    }
                    
                    restaurantData.forEach(function(restaurant, index) {
                        if (!restaurant.lat || !restaurant.lng) {
                            console.warn('âš ï¸ Skipping restaurant without coordinates:', restaurant.name);
                            return;
                        }
                        
                        hasValidMarkers = true;
                        var position = new kakao.maps.LatLng(restaurant.lat, restaurant.lng);
                        
                        // ë§ˆì»¤ ìƒì„±
                        var marker = new kakao.maps.Marker({
                            position: position,
                            map: map
                        });
                        markers.push(marker);
                        
                        // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ìƒì„± (ìˆœìœ„ + ì´ë¦„ + ê±°ë¦¬)
                        var rank = restaurant.rank || (index + 1);
                        var distance = restaurant.distance || '';
                        var content = document.createElement('div');
                        content.className = 'marker-card';
                        content.setAttribute('data-id', restaurant.id);
                        content.innerHTML = 
                            '<div class="rank-badge">' + escapeHtml(rank) + '</div>' +
                            '<div class="restaurant-name">' + escapeHtml(restaurant.name) + '</div>' +
                            (distance ? '<div class="restaurant-distance">' + escapeHtml(distance) + '</div>' : '');
                        
                        // í´ë¦­ ì´ë²¤íŠ¸ (ë”ë¸”í´ë¦­ ê°ì§€)
                        content.onclick = function() {
                            var currentTime = new Date().getTime();
                            var isDoubleClick = false;
                            
                            // ë”ë¸”í´ë¦­ ê°ì§€ (500ms ì´ë‚´ ê°™ì€ ë§ˆì»¤ í´ë¦­)
                            if (lastClickId === restaurant.id && (currentTime - lastClickTime) < 500) {
                                isDoubleClick = true;
                                lastClickTime = 0;
                                lastClickId = null;
                            } else {
                                lastClickTime = currentTime;
                                lastClickId = restaurant.id;
                            }
                            
                            // Flutterì— í´ë¦­ ì´ë²¤íŠ¸ ì „ë‹¬
                            if (window.flutter_inappwebview) {
                                window.flutter_inappwebview.callHandler('onMarkerClick', restaurant.id, restaurant.name, isDoubleClick);
                            }
                        };
                        
                        var customOverlay = new kakao.maps.CustomOverlay({
                            position: position,
                            content: content,
                            yAnchor: 2.2,
                            zIndex: 1 // ê¸°ë³¸ z-index
                        });
                        customOverlay.setMap(map);
                        customOverlay.restaurantId = restaurant.id;
                        overlays.push(customOverlay);
                        
                        // ë§ˆì»¤ë„ ì €ì¥ (z-index ì¡°ì •ìš©)
                        marker.restaurantId = restaurant.id;
                        
                        bounds.extend(position);
                    });
                    
                    // ì§€ë„ ë²”ìœ„ ì¡°ì • - ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ í›„ ë‚´ ìœ„ì¹˜ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ì •
                    // ë§ˆì»¤ ë Œë”ë§ì´ ì™„ë£Œëœ í›„ ì¤‘ì‹¬ ì„¤ì •ì„ ìœ„í•´ setTimeout ì‚¬ìš©
                    setTimeout(function() {
                        map.setCenter(new kakao.maps.LatLng(centerLat, centerLng));
                        map.setLevel(5);
                        console.log('âœ… Map center set to my location after markers loaded:', centerLat, centerLng);
                    }, 100);
                    
                    document.getElementById('loading').style.display = 'none';
                    console.log('âœ… Map initialized with', restaurantData.length, 'markers');
                    if (resolve) resolve('success');
                    
                } catch (innerError) {
                    console.error('âŒ Map initialization inner error:', innerError);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error-msg').style.display = 'block';
                    document.getElementById('error-msg').textContent = 'ì§€ë„ ë¡œë”© ì‹¤íŒ¨: ' + innerError.message;
                    if (reject) reject(innerError.message);
                }
            });
        }
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ì§€ë„ ì´ˆê¸°í™”
        // showMyLocation: trueì´ë©´ ë‚´ ìœ„ì¹˜ì— ë¹¨ê°„ìƒ‰ ë§ˆì»¤ í‘œì‹œ
        window.initializeMap = function(centerLat, centerLng, markersJson, showMyLocation) {
            return new Promise(function(resolve, reject) {
                try {
                    console.log('ğŸ—ºï¸ initializeMap called');
                    console.log('ğŸ“ Center:', centerLat, centerLng);
                    console.log('ğŸ“ Show my location:', showMyLocation);
                    
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('error-msg').style.display = 'none';
                    
                    // SDKê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (kakaoSdkReady && typeof kakao !== 'undefined' && kakao.maps) {
                        doInitializeMap(centerLat, centerLng, markersJson, resolve, reject, showMyLocation);
                    } else {
                        console.log('â³ Waiting for Kakao SDK...');
                        // SDK ë¡œë”© ëŒ€ê¸° í›„ ì´ˆê¸°í™”
                        waitForKakaoSdk(function() {
                            doInitializeMap(centerLat, centerLng, markersJson, resolve, reject, showMyLocation);
                        });
                    }
                    
                } catch (error) {
                    console.error('âŒ Map initialization error:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error-msg').style.display = 'block';
                    document.getElementById('error-msg').textContent = 'ì§€ë„ ë¡œë”© ì‹¤íŒ¨: ' + error.message;
                    reject(error.message);
                }
            });
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        window.setMyLocation = function(lat, lng) {
            if (!map) {
                console.error('âŒ Map not initialized');
                return 'error: map not initialized';
            }
            
            try {
                createMyLocationMarker(lat, lng);
                return 'success';
            } catch (error) {
                console.error('âŒ setMyLocation error:', error);
                return 'error: ' + error.message;
            }
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ì¹´ë©”ë¼ ì´ë™
        window.moveCamera = function(lat, lng) {
            if (!map) {
                console.error('âŒ Map not initialized');
                return 'error: map not initialized';
            }
            
            try {
                var position = new kakao.maps.LatLng(lat, lng);
                map.setCenter(position);
                map.setLevel(3); // ë” ê°€ê¹Œì´ ì¤Œì¸
                console.log('âœ… Camera moved to:', lat, lng);
                return 'success';
            } catch (error) {
                console.error('âŒ moveCamera error:', error);
                return 'error: ' + error.message;
            }
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: íŠ¹ì • ë§ˆì»¤ ì„ íƒ (í•˜ì´ë¼ì´íŠ¸)
        window.selectMarker = function(restaurantId) {
            if (!map) return 'error: map not initialized';
            
            try {
                // ì´ì „ ì„ íƒ í•´ì œ
                if (selectedOverlay) {
                    var prevContent = selectedOverlay.getContent();
                    if (prevContent) {
                        prevContent.classList.remove('selected');
                    }
                    // ì´ì „ ë§ˆì»¤ z-index ë³µì›
                    selectedOverlay.setZIndex(1);
                }
                if (selectedMarker) {
                    selectedMarker.setZIndex(1);
                }
                
                // ìƒˆë¡œìš´ ì„ íƒ
                for (var i = 0; i < overlays.length; i++) {
                    if (overlays[i].restaurantId === restaurantId) {
                        var content = overlays[i].getContent();
                        if (content) {
                            content.classList.add('selected');
                        }
                        selectedOverlay = overlays[i];
                        // ì„ íƒëœ ì˜¤ë²„ë ˆì´ì˜ z-indexë¥¼ ë†’ì„
                        selectedOverlay.setZIndex(1000);
                        
                        // í•´ë‹¹ ë§ˆì»¤ ì°¾ê¸°
                        for (var j = 0; j < markers.length; j++) {
                            if (markers[j].restaurantId === restaurantId) {
                                selectedMarker = markers[j];
                                selectedMarker.setZIndex(1000);
                                break;
                            }
                        }
                        
                        // í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
                        map.setCenter(overlays[i].getPosition());
                        map.setLevel(3);
                        break;
                    }
                }
                
                console.log('âœ… Marker selected:', restaurantId);
                return 'success';
            } catch (error) {
                console.error('âŒ selectMarker error:', error);
                return 'error: ' + error.message;
            }
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ì¤Œì¸
        window.zoomIn = function() {
            if (!map) return 'error: map not initialized';
            var level = map.getLevel();
            map.setLevel(level - 1);
            return 'success';
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ì¤Œì•„ì›ƒ
        window.zoomOut = function() {
            if (!map) return 'error: map not initialized';
            var level = map.getLevel();
            map.setLevel(level + 1);
            return 'success';
        };
        
        // ë§ˆì»¤ ì œê±° í•¨ìˆ˜
        function clearMarkers() {
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
            
            overlays.forEach(function(overlay) {
                overlay.setMap(null);
            });
            overlays = [];
            selectedOverlay = null;
            
            // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ë„ ì œê±°
            if (myLocationOverlay) {
                myLocationOverlay.setMap(null);
                myLocationOverlay = null;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì•Œë¦¼
        console.log('âœ… Kakao Map HTML ready');
    </script>
</body>
</html>



<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kakao Map</title>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error-msg {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid red;
            border-radius: 8px;
            color: red;
            text-align: center;
            z-index: 1000;
        }
        .marker-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 8px 12px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .marker-card:hover {
            transform: scale(1.05);
        }
        .marker-card.selected {
            border: 2px solid #3B82F6;
            background-color: #EFF6FF;
            z-index: 1000 !important;
        }
        .rank-badge {
            background-color: #3B82F6;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }
        .restaurant-name {
            font-size: 14px;
            font-weight: bold;
            color: #1F2937;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        .restaurant-distance {
            font-size: 12px;
            color: #6B7280;
            margin-left: 4px;
            flex-shrink: 0;
        }
        .my-location-marker {
            width: 24px;
            height: 24px;
            background-color: #EF4444;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        .my-location-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
        }
        .my-location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-color: rgba(239, 68, 68, 0.3);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        /* í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
        .cluster-marker {
            background-color: white;
            border: 2px solid #3B82F6;
            border-radius: 20px;
            padding: 8px 14px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .cluster-marker:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .cluster-icon {
            width: 20px;
            height: 20px;
            background-color: #3B82F6;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .cluster-icon svg {
            width: 12px;
            height: 12px;
            fill: white;
        }
        .cluster-text {
            font-size: 13px;
            font-weight: 600;
            color: #1F2937;
        }
        .cluster-count {
            font-size: 13px;
            font-weight: bold;
            color: #3B82F6;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>ì§€ë„ ë¡œë”© ì¤‘...</div>
    </div>
    <div id="error-msg"></div>
    <div id="map"></div>
    
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=KAKAO_JS_KEY_PLACEHOLDER&autoload=false"></script>
    <script>
        console.log('ğŸ”µ Kakao Map HTML loaded');
        
        // ì „ì—­ ë³€ìˆ˜
        var map = null;
        var markers = [];
        var overlays = [];
        var clusterOverlays = []; // í´ëŸ¬ìŠ¤í„° ì˜¤ë²„ë ˆì´
        var selectedOverlay = null;
        var selectedMarker = null; // ì„ íƒëœ ë§ˆì»¤
        var selectedRestaurantId = null; // ì„ íƒëœ ìŒì‹ì  ID
        var kakaoSdkReady = false;
        var pendingInit = null; // ëŒ€ê¸° ì¤‘ì¸ ì´ˆê¸°í™” ìš”ì²­
        var myLocationMarker = null; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
        var myLocationOverlay = null; // ë‚´ ìœ„ì¹˜ ì˜¤ë²„ë ˆì´
        var lastClickTime = 0; // ë”ë¸”í´ë¦­ ê°ì§€ìš©
        var lastClickId = null; // ë§ˆì§€ë§‰ í´ë¦­í•œ ë§ˆì»¤ ID
        var currentZoomLevel = 5; // í˜„ì¬ ì¤Œ ë ˆë²¨
        var restaurantDataCache = []; // ìŒì‹ì  ë°ì´í„° ìºì‹œ
        var clusteringEnabled = true; // í´ëŸ¬ìŠ¤í„°ë§ í™œì„±í™”
        var debounceTimer = null; // ë””ë°”ìš´ìŠ¤ íƒ€ì´ë¨¸
        var initialRenderDone = true; // ì´ˆê¸° ë Œë”ë§ ì™„ë£Œ í”Œë˜ê·¸
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (XSS ë°©ì§€)
        function escapeHtml(unsafe) {
            if (unsafe == null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // ==================== í´ëŸ¬ìŠ¤í„°ë§ ì•Œê³ ë¦¬ì¦˜ ====================
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í´ëŸ¬ìŠ¤í„°ë§ ê±°ë¦¬ ê³„ì‚°
        function calculateClusterDistance(zoomLevel) {
            // ê¸°ë³¸ ê±°ë¦¬ (í”½ì…€)
            var baseDistance = 80;
            // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ë°°ìœ¨ ê³„ì‚° (ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ = í™•ëŒ€, í´ëŸ¬ìŠ¤í„° ê±°ë¦¬ ê°ì†Œ)
            // ì¹´ì¹´ì˜¤ë§µ ì¤Œ ë ˆë²¨: 1(ê°€ì¥ í™•ëŒ€) ~ 14(ê°€ì¥ ì¶•ì†Œ)
            var levelMultiplier = Math.pow(1.3, zoomLevel - 3);
            return baseDistance * levelMultiplier;
        }
        
        // ë‘ ì¢Œí‘œ ê°„ì˜ í™”ë©´ìƒ í”½ì…€ ê±°ë¦¬ ê³„ì‚°
        function getDistanceInPixels(pos1, pos2) {
            if (!map) return Infinity;
            
            try {
                var proj = map.getProjection();
                if (!proj) return Infinity;
                
                var point1 = proj.pointFromCoords(pos1);
                var point2 = proj.pointFromCoords(pos2);
                
                if (!point1 || !point2) return Infinity;
                
                var dx = point1.x - point2.x;
                var dy = point1.y - point2.y;
                
                return Math.sqrt(dx * dx + dy * dy);
            } catch (e) {
                console.error('getDistanceInPixels error:', e);
                return Infinity;
            }
        }
        
        // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ìƒì„±
        function createClusterGroups(positions, clusterDistance) {
            var groups = [];
            var assigned = new Set();
            
            for (var i = 0; i < positions.length; i++) {
                if (assigned.has(i)) continue;
                
                // ìƒˆ ê·¸ë£¹ ì‹œì‘
                var groupMarkers = [positions[i]];
                assigned.add(i);
                
                // í´ëŸ¬ìŠ¤í„° ê±°ë¦¬ ë‚´ì˜ ë‹¤ë¥¸ ë§ˆì»¤ë“¤ ì°¾ê¸°
                for (var j = i + 1; j < positions.length; j++) {
                    if (assigned.has(j)) continue;
                    
                    var dist = getDistanceInPixels(positions[i].position, positions[j].position);
                    
                    if (dist < clusterDistance) {
                        groupMarkers.push(positions[j]);
                        assigned.add(j);
                    }
                }
                
                // ê·¸ë£¹ ì¤‘ì‹¬ì  ê³„ì‚°
                var center;
                if (groupMarkers.length > 1) {
                    var sumLat = 0, sumLng = 0;
                    for (var k = 0; k < groupMarkers.length; k++) {
                        sumLat += groupMarkers[k].position.getLat();
                        sumLng += groupMarkers[k].position.getLng();
                    }
                    center = new kakao.maps.LatLng(
                        sumLat / groupMarkers.length,
                        sumLng / groupMarkers.length
                    );
                } else {
                    center = groupMarkers[0].position;
                }
                
                groups.push({
                    markers: groupMarkers,
                    center: center
                });
            }
            
            return groups;
        }
        
        // ê°œë³„ ë§ˆì»¤ ë Œë”ë§
        function renderSingleMarker(data, isFocused) {
            console.log('ğŸ“ renderSingleMarker:', data.name, ', focused:', isFocused);
            var position = new kakao.maps.LatLng(data.lat, data.lng);
            
            // ë§ˆì»¤ ìƒì„±
            var marker = new kakao.maps.Marker({
                position: position,
                map: map,
                zIndex: isFocused ? 1000 : 1
            });
            markers.push(marker);
            marker.restaurantId = data.id;
            
            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ìƒì„±
            var content = document.createElement('div');
            content.className = 'marker-card' + (isFocused ? ' selected' : '');
            content.setAttribute('data-id', data.id);
            content.innerHTML = 
                '<div class="rank-badge">' + escapeHtml(data.rank) + '</div>' +
                '<div class="restaurant-name">' + escapeHtml(data.name) + '</div>' +
                (data.distance ? '<div class="restaurant-distance">' + escapeHtml(data.distance) + '</div>' : '');
            
            // í´ë¦­ ì´ë²¤íŠ¸
            content.onclick = function() {
                var isDoubleClick = false;
                
                // ì´ë¯¸ ì„ íƒëœ ë§ˆì»¤ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™
                if (selectedRestaurantId === data.id) {
                    isDoubleClick = true;
                } else {
                    // ìƒˆë¡œìš´ ë§ˆì»¤ ì„ íƒ
                    // ë§ˆì»¤ í´ë¦­ ì‹œ ìë™ìœ¼ë¡œ ì„ íƒ íš¨ê³¼ ì ìš©
                    selectMarkerDirect(data.id, content, customOverlay, marker);
                }
                
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('onMarkerClick', data.id, data.name, isDoubleClick);
                }
            };
            
            var customOverlay = new kakao.maps.CustomOverlay({
                position: position,
                content: content,
                yAnchor: 2.2,
                zIndex: isFocused ? 1000 : 1
            });
            customOverlay.setMap(map);
            customOverlay.restaurantId = data.id;
            overlays.push(customOverlay);
            
            if (isFocused) {
                selectedOverlay = customOverlay;
                selectedMarker = marker;
            }
        }
        
        // í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ë Œë”ë§
        function renderCluster(group) {
            var content = document.createElement('div');
            content.className = 'cluster-marker';
            content.innerHTML = 
                '<div class="cluster-icon">' +
                    '<svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>' +
                '</div>' +
                '<span class="cluster-text">ë§›ì§‘</span>' +
                '<span class="cluster-count">' + group.markers.length + 'ê°œ</span>';
            
            // í´ëŸ¬ìŠ¤í„° í´ë¦­ ì‹œ ì¤Œì¸
            content.onclick = function() {
                var newLevel = Math.max(1, currentZoomLevel - 2);
                map.setLevel(newLevel);
                map.setCenter(group.center);
                
                // Flutterì— í´ëŸ¬ìŠ¤í„° í´ë¦­ ì•Œë¦¼
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('onClusterClick', group.markers.length, group.center.getLat(), group.center.getLng());
                }
            };
            
            var clusterOverlay = new kakao.maps.CustomOverlay({
                position: group.center,
                content: content,
                yAnchor: 0.5,
                zIndex: 100
            });
            clusterOverlay.setMap(map);
            clusterOverlays.push(clusterOverlay);
        }
        
        // í´ëŸ¬ìŠ¤í„°ë§ ì ìš© ë Œë”ë§
        function renderMarkersWithClustering() {
            console.log('ğŸ” renderMarkersWithClustering called - map:', !!map, ', clusteringEnabled:', clusteringEnabled, ', cacheLength:', restaurantDataCache.length);
            
            if (!map || restaurantDataCache.length === 0) {
                console.log('âš ï¸ renderMarkersWithClustering skipped - no map or no data');
                return;
            }
            
            try {
                // ê¸°ì¡´ ë§ˆì»¤/ì˜¤ë²„ë ˆì´ ì œê±° (ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ì œì™¸)
                clearMarkersOnly();
                
                // í´ëŸ¬ìŠ¤í„°ë§ ë¹„í™œì„±í™” ë˜ëŠ” ì¤Œ ë ˆë²¨ì´ ë‚®ìœ¼ë©´ ëª¨ë“  ë§ˆì»¤ ê°œë³„ í‘œì‹œ
                // ì¹´ì¹´ì˜¤ë§µ ì¤Œ ë ˆë²¨: 1(ê°€ì¥ í™•ëŒ€) ~ 14(ê°€ì¥ ì¶•ì†Œ)
                // ì¤Œ ë ˆë²¨ 4 ì´ìƒ(ë” ì¶•ì†Œ)ì—ì„œ í´ëŸ¬ìŠ¤í„°ë§ ì ìš©
                if (!clusteringEnabled || currentZoomLevel <= 3) {
                    for (var i = 0; i < restaurantDataCache.length; i++) {
                        var data = restaurantDataCache[i];
                        var isFocused = selectedRestaurantId && data.id === selectedRestaurantId;
                        renderSingleMarker(data, isFocused);
                    }
                    console.log('âœ… Rendered', restaurantDataCache.length, 'individual markers (zoom:', currentZoomLevel, ')');
                    return;
                }
                
                // ì„ íƒëœ ë§ˆì»¤ëŠ” í´ëŸ¬ìŠ¤í„°ë§ì—ì„œ ì œì™¸
                var focusedData = null;
                var otherData = [];
                
                for (var i = 0; i < restaurantDataCache.length; i++) {
                    var data = restaurantDataCache[i];
                    if (selectedRestaurantId && data.id === selectedRestaurantId) {
                        focusedData = data;
                    } else {
                        otherData.push({
                            data: data,
                            position: new kakao.maps.LatLng(data.lat, data.lng)
                        });
                    }
                }
                
                // ì„ íƒëœ ë§ˆì»¤ëŠ” í•­ìƒ ê°œë³„ í‘œì‹œ
                if (focusedData) {
                    renderSingleMarker(focusedData, true);
                }
                
                // ì¤Œ ë ˆë²¨ 5+: í´ëŸ¬ìŠ¤í„°ë§ ì ìš©
                var clusterDistance = calculateClusterDistance(currentZoomLevel);
                var groups = createClusterGroups(otherData, clusterDistance);
                
                var clusterCount = 0;
                var singleCount = 0;
                
                for (var g = 0; g < groups.length; g++) {
                    var group = groups[g];
                    if (group.markers.length === 1) {
                        // ë‹¨ì¼ ë§ˆì»¤
                        renderSingleMarker(group.markers[0].data, false);
                        singleCount++;
                    } else {
                        // í´ëŸ¬ìŠ¤í„°
                        renderCluster(group);
                        clusterCount++;
                    }
                }
                
                console.log('âœ… Clustering applied:', clusterCount, 'clusters,', singleCount, 'single markers (zoom:', currentZoomLevel, ', distance:', clusterDistance.toFixed(0), 'px)');
                
            } catch (error) {
                console.error('âŒ renderMarkersWithClustering error:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ë§ˆì»¤ í‘œì‹œ (fallback)
                try {
                    clearMarkersOnly();
                    for (var f = 0; f < restaurantDataCache.length; f++) {
                        renderSingleMarker(restaurantDataCache[f], false);
                    }
                    console.log('âœ… Fallback: Rendered', restaurantDataCache.length, 'markers without clustering');
                } catch (fallbackError) {
                    console.error('âŒ Fallback rendering also failed:', fallbackError);
                }
            }
        }
        
        // ë§ˆì»¤ë§Œ ì œê±° (ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ì œì™¸)
        function clearMarkersOnly() {
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
            
            overlays.forEach(function(overlay) {
                overlay.setMap(null);
            });
            overlays = [];
            
            clusterOverlays.forEach(function(overlay) {
                overlay.setMap(null);
            });
            clusterOverlays = [];
            
            selectedOverlay = null;
            selectedMarker = null;
        }
        
        // ë””ë°”ìš´ìŠ¤ ì ìš© í´ëŸ¬ìŠ¤í„°ë§ ì—…ë°ì´íŠ¸
        function updateClusteringDebounced() {
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            debounceTimer = setTimeout(function() {
                renderMarkersWithClustering();
            }, 150);
        }
        
        // ë§ˆì»¤ ì„ íƒ íš¨ê³¼ ì§ì ‘ ì ìš© (í´ëŸ¬ìŠ¤í„°ë§ ì¬ë Œë”ë§ ì—†ì´)
        function selectMarkerDirect(restaurantId, contentElement, overlay, marker) {
            // ì´ì „ ì„ íƒ í•´ì œ (DOMì—ì„œ ì§ì ‘)
            var prevSelected = document.querySelectorAll('.marker-card.selected');
            prevSelected.forEach(function(el) {
                el.classList.remove('selected');
            });
            
            // ì´ì „ ì˜¤ë²„ë ˆì´/ë§ˆì»¤ z-index ë³µì›
            if (selectedOverlay && selectedOverlay !== overlay) {
                selectedOverlay.setZIndex(1);
            }
            if (selectedMarker && selectedMarker !== marker) {
                selectedMarker.setZIndex(1);
            }
            
            // ìƒˆë¡œìš´ ì„ íƒ ì ìš©
            if (contentElement) {
                contentElement.classList.add('selected');
            }
            
            // ì„ íƒ ìƒíƒœ ì €ì¥
            selectedRestaurantId = restaurantId;
            selectedOverlay = overlay;
            selectedMarker = marker;
            
            // z-index ë†’ì´ê¸°
            if (overlay) {
                overlay.setZIndex(1000);
            }
            if (marker) {
                marker.setZIndex(1000);
            }
            
            console.log('âœ… Marker selected (direct):', restaurantId);
        }
        
        // ==================== í´ëŸ¬ìŠ¤í„°ë§ ì•Œê³ ë¦¬ì¦˜ ë ====================
        
        // SDK ë¡œë”© ëŒ€ê¸° í•¨ìˆ˜
        function waitForKakaoSdk(callback, maxAttempts, attempt) {
            attempt = attempt || 0;
            maxAttempts = maxAttempts || 50;
            
            if (typeof kakao !== 'undefined' && kakao.maps) {
                console.log('âœ… Kakao SDK ready after', attempt, 'attempts');
                kakaoSdkReady = true;
                callback();
            } else if (attempt < maxAttempts) {
                setTimeout(function() {
                    waitForKakaoSdk(callback, maxAttempts, attempt + 1);
                }, 100);
            } else {
                console.error('âŒ Kakao SDK loading timeout');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').textContent = 'ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë”© ì‹œê°„ ì´ˆê³¼';
            }
        }
        
        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
        function createMyLocationMarker(lat, lng) {
            if (!map) return;
            
            // ê¸°ì¡´ ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ì œê±°
            if (myLocationOverlay) {
                myLocationOverlay.setMap(null);
            }
            
            var position = new kakao.maps.LatLng(lat, lng);
            
            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¡œ ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±
            var content = document.createElement('div');
            content.style.position = 'relative';
            content.innerHTML = 
                '<div class="my-location-pulse"></div>' +
                '<div class="my-location-marker"></div>';
            
            myLocationOverlay = new kakao.maps.CustomOverlay({
                position: position,
                content: content,
                yAnchor: 0.5,
                xAnchor: 0.5,
                zIndex: 100
            });
            myLocationOverlay.setMap(map);
            
            console.log('âœ… My location marker created at:', lat, lng);
        }
        
        // ì‹¤ì œ ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
        function doInitializeMap(centerLat, centerLng, markersJson, resolve, reject, showMyLocation) {
            kakao.maps.load(function() {
                try {
                    var restaurantData = JSON.parse(markersJson);
                    console.log('âœ… Parsed', restaurantData.length, 'markers');
                    
                    // ë°ì´í„° ìºì‹œ ì €ì¥ (í´ëŸ¬ìŠ¤í„°ë§ìš©)
                    restaurantDataCache = [];
                    restaurantData.forEach(function(restaurant, index) {
                        if (restaurant.lat && restaurant.lng) {
                            restaurantDataCache.push({
                                id: restaurant.id,
                                name: restaurant.name,
                                lat: restaurant.lat,
                                lng: restaurant.lng,
                                rank: restaurant.rank || (index + 1),
                                distance: restaurant.distance || ''
                            });
                        }
                    });
                    console.log('âœ… restaurantDataCache populated with', restaurantDataCache.length, 'items');
                    
                    var container = document.getElementById('map');
                    var options = {
                        center: new kakao.maps.LatLng(centerLat, centerLng),
                        level: 5
                    };
                    
                    map = new kakao.maps.Map(container, options);
                    currentZoomLevel = 5;
                    console.log('âœ… Map created with center:', centerLat, centerLng);
                    
                    // ì§€ë„ ì¤‘ì‹¬ì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    var actualCenter = map.getCenter();
                    console.log('âœ… Actual map center:', actualCenter.getLat(), actualCenter.getLng());
                    
                    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                    clearMarkers();
                    
                    // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ (showMyLocationì´ trueì¸ ê²½ìš°)
                    if (showMyLocation) {
                        createMyLocationMarker(centerLat, centerLng);
                    }
                    
                    // ì¤Œ ë ˆë²¨ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
                    kakao.maps.event.addListener(map, 'zoom_changed', function() {
                        var newZoomLevel = map.getLevel();
                        if (newZoomLevel !== currentZoomLevel) {
                            currentZoomLevel = newZoomLevel;
                            console.log('ğŸ” Zoom level changed to:', currentZoomLevel);
                            // ì´ˆê¸° ë Œë”ë§ ì™„ë£Œ í›„, í´ëŸ¬ìŠ¤í„°ë§ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                            if (initialRenderDone && clusteringEnabled) {
                                updateClusteringDebounced();
                            }
                        }
                    });
                    
                    // ì§€ë„ ì¤‘ì‹¬ ì„¤ì • í›„ í´ëŸ¬ìŠ¤í„°ë§ ì ìš©í•˜ì—¬ ë§ˆì»¤ ë Œë”ë§
                    setTimeout(function() {
                        map.setCenter(new kakao.maps.LatLng(centerLat, centerLng));
                        map.setLevel(5);
                        currentZoomLevel = 5;
                        
                        // í´ëŸ¬ìŠ¤í„°ë§ ì ìš©í•˜ì—¬ ë§ˆì»¤ ë Œë”ë§
                        renderMarkersWithClustering();
                        
                        console.log('âœ… Map initialized with', restaurantData.length, 'markers');
                    }, 100);
                    
                    document.getElementById('loading').style.display = 'none';
                    console.log('âœ… Map initialized with', restaurantData.length, 'markers (clustering enabled)');
                    if (resolve) resolve('success');
                    
                } catch (innerError) {
                    console.error('âŒ Map initialization inner error:', innerError);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error-msg').style.display = 'block';
                    document.getElementById('error-msg').textContent = 'ì§€ë„ ë¡œë”© ì‹¤íŒ¨: ' + innerError.message;
                    if (reject) reject(innerError.message);
                }
            });
        }
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ì§€ë„ ì´ˆê¸°í™”
        // showMyLocation: trueì´ë©´ ë‚´ ìœ„ì¹˜ì— ë¹¨ê°„ìƒ‰ ë§ˆì»¤ í‘œì‹œ
        window.initializeMap = function(centerLat, centerLng, markersJson, showMyLocation) {
            return new Promise(function(resolve, reject) {
                try {
                    console.log('ğŸ—ºï¸ initializeMap called');
                    console.log('ğŸ“ Center:', centerLat, centerLng);
                    console.log('ğŸ“ Show my location:', showMyLocation);
                    
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('error-msg').style.display = 'none';
                    
                    // SDKê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (kakaoSdkReady && typeof kakao !== 'undefined' && kakao.maps) {
                        doInitializeMap(centerLat, centerLng, markersJson, resolve, reject, showMyLocation);
                    } else {
                        console.log('â³ Waiting for Kakao SDK...');
                        // SDK ë¡œë”© ëŒ€ê¸° í›„ ì´ˆê¸°í™”
                        waitForKakaoSdk(function() {
                            doInitializeMap(centerLat, centerLng, markersJson, resolve, reject, showMyLocation);
                        });
                    }
                    
                } catch (error) {
                    console.error('âŒ Map initialization error:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error-msg').style.display = 'block';
                    document.getElementById('error-msg').textContent = 'ì§€ë„ ë¡œë”© ì‹¤íŒ¨: ' + error.message;
                    reject(error.message);
                }
            });
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        window.setMyLocation = function(lat, lng) {
            if (!map) {
                console.error('âŒ Map not initialized');
                return 'error: map not initialized';
            }
            
            try {
                createMyLocationMarker(lat, lng);
                return 'success';
            } catch (error) {
                console.error('âŒ setMyLocation error:', error);
                return 'error: ' + error.message;
            }
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ì¹´ë©”ë¼ ì´ë™
        window.moveCamera = function(lat, lng) {
            if (!map) {
                console.error('âŒ Map not initialized');
                return 'error: map not initialized';
            }
            
            try {
                var position = new kakao.maps.LatLng(lat, lng);
                map.setCenter(position);
                map.setLevel(3); // ë” ê°€ê¹Œì´ ì¤Œì¸
                console.log('âœ… Camera moved to:', lat, lng);
                return 'success';
            } catch (error) {
                console.error('âŒ moveCamera error:', error);
                return 'error: ' + error.message;
            }
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: íŠ¹ì • ë§ˆì»¤ ì„ íƒ (í•˜ì´ë¼ì´íŠ¸)
        window.selectMarker = function(restaurantId) {
            if (!map) return 'error: map not initialized';
            
            try {
                // ì„ íƒëœ ìŒì‹ì  ID ì €ì¥
                selectedRestaurantId = restaurantId;
                
                // í•´ë‹¹ ìŒì‹ì ì˜ ì¢Œí‘œ ì°¾ê¸°
                var targetData = null;
                for (var i = 0; i < restaurantDataCache.length; i++) {
                    if (restaurantDataCache[i].id === restaurantId) {
                        targetData = restaurantDataCache[i];
                        break;
                    }
                }
                
                if (targetData) {
                    // í´ëŸ¬ìŠ¤í„°ë§ ë‹¤ì‹œ ë Œë”ë§ (ì„ íƒëœ ë§ˆì»¤ëŠ” ê°œë³„ í‘œì‹œë¨)
                    renderMarkersWithClustering();
                    
                    // í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
                    var targetPosition = new kakao.maps.LatLng(targetData.lat, targetData.lng);
                    map.setCenter(targetPosition);
                    map.setLevel(3);
                }
                
                console.log('âœ… Marker selected:', restaurantId);
                return 'success';
            } catch (error) {
                console.error('âŒ selectMarker error:', error);
                return 'error: ' + error.message;
            }
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ë§ˆì»¤ ì„ íƒ í•´ì œ
        window.clearMarkerSelection = function() {
            selectedRestaurantId = null;
            renderMarkersWithClustering();
            console.log('âœ… Marker selection cleared');
            return 'success';
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ì¤Œì¸
        window.zoomIn = function() {
            if (!map) return 'error: map not initialized';
            var level = map.getLevel();
            map.setLevel(level - 1);
            return 'success';
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: ì¤Œì•„ì›ƒ
        window.zoomOut = function() {
            if (!map) return 'error: map not initialized';
            var level = map.getLevel();
            map.setLevel(level + 1);
            return 'success';
        };
        
        // ë§ˆì»¤ ì œê±° í•¨ìˆ˜ (ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í¬í•¨)
        function clearMarkers() {
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
            
            overlays.forEach(function(overlay) {
                overlay.setMap(null);
            });
            overlays = [];
            
            clusterOverlays.forEach(function(overlay) {
                overlay.setMap(null);
            });
            clusterOverlays = [];
            
            selectedOverlay = null;
            selectedMarker = null;
            selectedRestaurantId = null;
            // restaurantDataCacheëŠ” ìœ ì§€ (í´ëŸ¬ìŠ¤í„°ë§ì— í•„ìš”)
            
            // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ë„ ì œê±°
            if (myLocationOverlay) {
                myLocationOverlay.setMap(null);
                myLocationOverlay = null;
            }
        }
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: í´ëŸ¬ìŠ¤í„°ë§ í™œì„±í™”/ë¹„í™œì„±í™”
        window.setClusteringEnabled = function(enabled) {
            clusteringEnabled = enabled;
            renderMarkersWithClustering();
            console.log('âœ… Clustering', enabled ? 'enabled' : 'disabled');
            return 'success';
        };
        
        // Flutterì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜: í˜„ì¬ ì¤Œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
        window.getZoomLevel = function() {
            if (!map) return -1;
            return map.getLevel();
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì•Œë¦¼
        console.log('âœ… Kakao Map HTML ready');
    </script>
</body>
</html>


